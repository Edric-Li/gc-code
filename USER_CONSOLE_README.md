# 用户控制台功能说明

## 概述

用户控制台是一个面向普通用户的管理界面，允许已登录的用户管理自己的 API Keys、查看使用统计和日志记录。

## 功能特性

### 1. 控制台首页 (`/console`)

**路由**: `/console`

**功能描述**:

- 根据当前时间显示个性化问候语（早上好、中午好、下午好、晚上好等）
- 显示用户的显示名称、用户名或邮箱
- 提供三个核心功能入口：
  - **数据看板**: 查看使用统计和费用概览
  - **API Key 管理**: 管理你的 API 令牌
  - **使用日志**: 查看 API 调用记录

**权限**: 仅登录用户可访问

### 2. 数据看板 (`/console/dashboard`)

**路由**: `/console/dashboard`

**功能描述**:

- 显示用户所有 API Key 的聚合统计数据
- 支持按日期范围筛选（最近7天、最近30天、自定义范围）
- 支持按单个 API Key 过滤查看

**统计指标**:

- **总费用**: 显示选定时间范围内的总费用
- **请求次数**: API 调用的总次数
- **成功率**: 成功请求的百分比
- **活跃令牌**: 当前ACTIVE状态的 API Key数量

**API Keys 使用概览表**:

- 列出所有 API Key 的详细使用情况
- 显示名称、状态、请求数、成功率、费用、最后使用时间等信息

**权限**: 仅登录用户可访问，只能看到自己的数据

### 3. API Key 管理 (`/console/api-keys`)

**路由**: `/console/api-keys`

**功能描述**:

- 创建新的 API Key
- 查看所有 API Key 列表
- 显示/隐藏 API Key 完整内容
- 复制 API Key 到剪贴板
- 撤销 API Key（将状态改为 REVOKED）
- 删除 API Key（软删除）

**创建 API Key**:

- 必填字段：名称
- 可选字段：
  - 描述
  - 每日费用限制
  - 过期时间
- **创建限制**: 每个用户最多可以创建 20 个 API Key（不包括已删除的）
- 页面会显示当前已创建的数量 (X/20)
- 达到上限后需要先删除不用的 API Key 才能创建新的

**重要提示**: 创建成功后会显示完整的 API Key，这是唯一一次可以查看完整密钥的机会，请务必保存。

**API Key 信息展示**:

- 名称和描述
- 状态标签（ACTIVE/EXPIRED/REVOKED/DELETED）
- 脱敏显示的 API Key（可切换显示/隐藏）
- 使用统计：
  - 请求数
  - 成功率
  - 总费用
  - 最后使用时间

**权限**: 仅登录用户可访问，只能管理自己的 API Keys

### 4. 使用日志 (`/console/logs`)

**路由**: `/console/logs`

**功能描述**:

- 查看当前用户所有 API Key 的详细请求日志
- 支持按 API Key 筛选
- 分页显示（每页20条）

**日志信息**:

- 时间（精确到秒）
- API Key 名称
- 使用的模型
- 请求状态（成功/失败 + HTTP状态码）
- Token 使用情况：
  - 输入 Token 数量
  - 输出 Token 数量
  - 缓存读取 Token 数量（如有）
- 请求耗时
- 费用

**权限**: 仅登录用户可访问，只能看到自己的日志

### 5. 首页集成

**更新内容**:

- 已登录用户：首页显示"进入控制台"按钮（主按钮）和"查看文档"按钮（次要按钮）
- 未登录用户：首页显示"快速开始"按钮和"用量查询"按钮（保持原样）

## 技术实现

### 前端

**新增文件**:

- `/src/pages/console/Console.tsx` - 控制台首页
- `/src/pages/console/Dashboard.tsx` - 数据看板
- `/src/pages/console/ApiKeys.tsx` - API Key 管理
- `/src/pages/console/Logs.tsx` - 使用日志
- `/src/hooks/useAuth.ts` - 认证 Hook 导出

**修改文件**:

- `/src/router/index.tsx` - 添加控制台路由
- `/src/pages/Home.tsx` - 添加控制台入口按钮
- `/src/utils/format.ts` - 添加货币格式化函数
- `/src/services/apiKeyApi.ts` - API Key 服务接口

**路由配置**:

```typescript
// 控制台路由
/console                - 控制台首页
/console/dashboard      - 数据看板
/console/api-keys       - API Key 管理
/console/logs           - 使用日志
```

### 后端

**API 接口**:
所有接口都通过 JWT token 自动识别当前用户，确保数据安全性。

- `GET /api-keys` - 获取当前用户的 API Key 列表
- `POST /api-keys` - 创建 API Key（管理员权限，需传递userId）
- `POST /api-keys/my-keys` - 为当前用户创建 API Key（普通用户，限制20个）
- `GET /api-keys/stats/overview` - 获取用户总体统计
- `GET /api-keys/request-logs/all` - 获取所有 API Key 的请求日志
- `GET /api-keys/:id` - 获取 API Key 详情
- `PATCH /api-keys/:id` - 更新 API Key
- `DELETE /api-keys/:id` - 删除 API Key
- `POST /api-keys/:id/revoke` - 撤销 API Key

**权限控制**:

- 所有控制台相关接口都需要 JWT 认证
- 管理员可以为任何用户创建 API Key（通过 `POST /api-keys`）
- 普通用户可以为自己创建 API Key（通过 `POST /api-keys/my-keys`），限制20个
- 用户只能访问和操作自己的 API Keys

## 使用流程

### 首次使用

1. 用户登录系统
2. 在首页点击"进入控制台"按钮
3. 查看控制台首页，了解功能模块
4. 点击"API Key 管理"创建第一个 API Key
5. 保存创建成功后显示的完整 API Key
6. 使用 API Key 开始调用服务

### 日常使用

1. 通过首页或直接访问 `/console` 进入控制台
2. 在数据看板查看使用情况和费用
3. 在 API Key 管理中查看所有密钥状态
4. 在使用日志中查看详细的调用记录
5. 根据需要创建新的 API Key 或撤销不再使用的密钥

## 注意事项

### 安全性

1. **API Key 保护**:
   - API Key 在列表中默认脱敏显示
   - 完整 API Key 仅在创建时显示一次
   - 建议定期轮换 API Keys

2. **权限隔离**:
   - 用户只能看到自己的数据
   - 后端通过 JWT token 自动识别用户身份
   - 所有接口都有认证保护

### 功能限制

1. **创建 API Key**:
   - ✅ 普通用户可以自主创建 API Key（通过控制台）
   - ⚠️ 每个用户最多创建 20 个 API Key（不包括已删除的）
   - 达到上限后必须删除不用的 API Key 才能创建新的
   - 管理员可以为任何用户创建 API Key（无数量限制）

2. **数据查询**:
   - 统计数据有时间范围限制
   - 日志默认显示最近的记录
   - 大量数据时需要使用筛选和分页功能

## 后续优化建议

1. ✅ ~~**用户自主创建 API Key**~~: 已实现，每个用户限制20个
2. **更多统计维度**: 添加按时间段的趋势图表
3. **导出功能**: 支持导出使用数据和日志
4. **告警通知**: 费用超限或异常使用时发送通知
5. **API Key 编辑**: 支持修改 API Key 的名称、描述等信息
6. **配额管理**: 允许管理员调整用户的 API Key 创建上限

## 测试建议

### 功能测试

1. **登录状态测试**:
   - 未登录时首页应显示"快速开始"和"用量查询"按钮
   - 登录后首页应显示"进入控制台"和"查看文档"按钮
   - 直接访问 `/console` 路由在未登录时应重定向到登录页

2. **控制台首页测试**:
   - 检查问候语是否根据时间正确显示
   - 检查用户名是否正确显示
   - 检查三个功能卡片是否可点击并正确跳转

3. **数据看板测试**:
   - 测试日期范围筛选功能
   - 测试 API Key 过滤功能
   - 验证统计数据的准确性

4. **API Key 管理测试**:
   - 测试创建 API Key 流程
   - 测试创建数量限制（20个上限）
   - 测试达到上限时按钮禁用状态
   - 测试删除后可以继续创建
   - 测试显示/隐藏 API Key
   - 测试复制功能
   - 测试撤销和删除功能

5. **使用日志测试**:
   - 测试日志列表显示
   - 测试 API Key 筛选
   - 测试分页功能

### 边界测试

1. 无数据情况：新用户没有任何 API Key 时的显示
2. 大量数据情况：用户有很多 API Key 时的性能
3. 网络异常情况：API 请求失败时的错误处理

## 相关文档

- [API Keys 管理文档](./docs/api-keys.md)
- [使用统计文档](./docs/usage-stats.md)
- [认证系统文档](./docs/authentication.md)
