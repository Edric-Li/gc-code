// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  USER
  ADMIN
}

enum OAuthProvider {
  AZURE_AD
  GOOGLE
  GITHUB
  MICROSOFT
}

enum LoginMethod {
  LOCAL
  AZURE_AD
  GOOGLE
  GITHUB
}

enum AuditAction {
  CREATE
  UPDATE
  DELETE
  LOGIN
  LOGOUT
  EXPORT
  IMPORT
}

enum HttpMethod {
  GET
  POST
  PUT
  PATCH
  DELETE
  OPTIONS
  HEAD
}

model User {
  id            String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  username      String   @unique @db.VarChar(100)
  email         String   @unique @db.VarChar(255)
  passwordHash  String?  @map("password_hash") @db.VarChar(255)
  displayName   String?  @map("display_name") @db.VarChar(255)
  avatarUrl     String?  @map("avatar_url") @db.VarChar(500)
  role          Role     @default(USER)
  isActive      Boolean  @default(true) @map("is_active")
  createdAt     DateTime @default(now()) @map("created_at") @db.Timestamp(3)
  updatedAt     DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamp(3)
  lastLoginAt   DateTime? @map("last_login_at") @db.Timestamp(3)

  oauthAccounts OAuthAccount[]
  loginLogs     LoginLog[]
  auditLogs     AuditLog[]
  apiLogs       ApiLog[]

  @@index([email], name: "idx_users_email")
  @@index([username], name: "idx_users_username")
  @@map("users")
}

model OAuthAccount {
  id           String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId       String        @map("user_id") @db.Uuid
  provider     OAuthProvider
  providerId   String        @map("provider_id") @db.VarChar(255)
  email        String?       @db.VarChar(255)
  displayName  String?       @map("display_name") @db.VarChar(255)
  avatarUrl    String?       @map("avatar_url") @db.VarChar(500)
  accessToken  String?       @map("access_token") @db.Text
  refreshToken String?       @map("refresh_token") @db.Text
  expiresAt    DateTime?     @map("expires_at") @db.Timestamp(3)
  createdAt    DateTime      @default(now()) @map("created_at") @db.Timestamp(3)
  updatedAt    DateTime      @default(now()) @updatedAt @map("updated_at") @db.Timestamp(3)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerId])
  @@unique([userId, provider])
  @@index([provider], name: "idx_oauth_accounts_provider")
  @@index([userId], name: "idx_oauth_accounts_user_id")
  @@map("oauth_accounts")
}

// 登录日志
model LoginLog {
  id           String       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId       String?      @map("user_id") @db.Uuid
  email        String       @db.VarChar(255)
  loginMethod  LoginMethod  @map("login_method")
  success      Boolean
  ipAddress    String?      @map("ip_address") @db.VarChar(100)
  userAgent    String?      @map("user_agent") @db.Text
  errorMessage String?      @map("error_message") @db.Text
  createdAt    DateTime     @default(now()) @map("created_at") @db.Timestamp(3)

  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId], name: "idx_login_logs_user_id")
  @@index([createdAt], name: "idx_login_logs_created_at")
  @@index([success], name: "idx_login_logs_success")
  @@map("login_logs")
}

// 操作审计日志
model AuditLog {
  id          String       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId      String       @map("user_id") @db.Uuid
  action      AuditAction
  resource    String       @db.VarChar(100)
  resourceId  String?      @map("resource_id") @db.VarChar(255)
  description String?      @db.Text
  changes     Json?
  ipAddress   String?      @map("ip_address") @db.VarChar(100)
  userAgent   String?      @map("user_agent") @db.Text
  createdAt   DateTime     @default(now()) @map("created_at") @db.Timestamp(3)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId], name: "idx_audit_logs_user_id")
  @@index([createdAt], name: "idx_audit_logs_created_at")
  @@index([action], name: "idx_audit_logs_action")
  @@index([resource], name: "idx_audit_logs_resource")
  @@map("audit_logs")
}

// API 访问日志
model ApiLog {
  id           String      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId       String?     @map("user_id") @db.Uuid
  method       HttpMethod
  path         String      @db.VarChar(500)
  statusCode   Int         @map("status_code")
  duration     Int         // 毫秒
  ipAddress    String?     @map("ip_address") @db.VarChar(100)
  userAgent    String?     @map("user_agent") @db.Text
  requestBody  Json?       @map("request_body")
  responseBody Json?       @map("response_body")
  errorMessage String?     @map("error_message") @db.Text
  createdAt    DateTime    @default(now()) @map("created_at") @db.Timestamp(3)

  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId], name: "idx_api_logs_user_id")
  @@index([createdAt], name: "idx_api_logs_created_at")
  @@index([path], name: "idx_api_logs_path")
  @@index([statusCode], name: "idx_api_logs_status_code")
  @@map("api_logs")
}
