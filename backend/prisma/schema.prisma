// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  USER
  ADMIN
}

enum OAuthProvider {
  AZURE_AD
  GOOGLE
  GITHUB
  MICROSOFT
}

enum LoginMethod {
  LOCAL
  AZURE_AD
  GOOGLE
  GITHUB
}

enum AuditAction {
  CREATE
  UPDATE
  DELETE
  LOGIN
  LOGOUT
  EXPORT
  IMPORT
}

enum HttpMethod {
  GET
  POST
  PUT
  PATCH
  DELETE
  OPTIONS
  HEAD
}

enum OrganizationType {
  DEPARTMENT // 部门
  PROJECT_GROUP // 项目组
  TEAM // 小组
  OTHER // 其他
}

enum OrganizationRole {
  OWNER // 创建者，拥有所有权限
  ADMIN // 管理员，可以管理成员和设置
  MEMBER // 普通成员
}

enum KeyStatus {
  ACTIVE // 激活中
  EXPIRED // 已过期
  REVOKED // 已撤销
  DELETED // 已删除（软删除）
}

enum ChannelStatus {
  ACTIVE // 正常使用
  DISABLED // 已禁用
  ERROR // 出现错误
  MAINTENANCE // 维护中
  RATE_LIMITED // 限流中
}

enum ProviderType {
  OPENAI
  ANTHROPIC
  AZURE_OPENAI
  GOOGLE_AI
  KIMI
  DEEPSEEK
  BAIDU
  ALIBABA
  CUSTOM // 自定义
}

model User {
  id           String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  username     String    @unique @db.VarChar(100)
  email        String    @unique @db.VarChar(255)
  passwordHash String?   @map("password_hash") @db.VarChar(255)
  displayName  String?   @map("display_name") @db.VarChar(255)
  avatarUrl    String?   @map("avatar_url") @db.VarChar(500)
  role         Role      @default(USER)
  isActive     Boolean   @default(true) @map("is_active")
  createdAt    DateTime  @default(now()) @map("created_at") @db.Timestamp(3)
  updatedAt    DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamp(3)
  lastLoginAt  DateTime? @map("last_login_at") @db.Timestamp(3)

  oauthAccounts       OAuthAccount[]
  loginLogs           LoginLog[]
  auditLogs           AuditLog[]
  apiLogs             ApiLog[]
  organizationMembers OrganizationMember[]
  apiKeys             ApiKey[]
  apiKeyUsage         ApiKeyUsage[]

  @@index([email], name: "idx_users_email")
  @@index([username], name: "idx_users_username")
  @@map("users")
}

model OAuthAccount {
  id           String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId       String        @map("user_id") @db.Uuid
  provider     OAuthProvider
  providerId   String        @map("provider_id") @db.VarChar(255)
  email        String?       @db.VarChar(255)
  displayName  String?       @map("display_name") @db.VarChar(255)
  avatarUrl    String?       @map("avatar_url") @db.VarChar(500)
  accessToken  String?       @map("access_token") @db.Text
  refreshToken String?       @map("refresh_token") @db.Text
  expiresAt    DateTime?     @map("expires_at") @db.Timestamp(3)
  createdAt    DateTime      @default(now()) @map("created_at") @db.Timestamp(3)
  updatedAt    DateTime      @default(now()) @updatedAt @map("updated_at") @db.Timestamp(3)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerId])
  @@unique([userId, provider])
  @@index([provider], name: "idx_oauth_accounts_provider")
  @@index([userId], name: "idx_oauth_accounts_user_id")
  @@map("oauth_accounts")
}

// 登录日志
model LoginLog {
  id           String      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId       String?     @map("user_id") @db.Uuid
  email        String      @db.VarChar(255)
  loginMethod  LoginMethod @map("login_method")
  success      Boolean
  ipAddress    String?     @map("ip_address") @db.VarChar(100)
  userAgent    String?     @map("user_agent") @db.Text
  errorMessage String?     @map("error_message") @db.Text
  createdAt    DateTime    @default(now()) @map("created_at") @db.Timestamp(3)

  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId], name: "idx_login_logs_user_id")
  @@index([createdAt], name: "idx_login_logs_created_at")
  @@index([success], name: "idx_login_logs_success")
  @@map("login_logs")
}

// 操作审计日志
model AuditLog {
  id          String      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId      String      @map("user_id") @db.Uuid
  action      AuditAction
  resource    String      @db.VarChar(100)
  resourceId  String?     @map("resource_id") @db.VarChar(255)
  description String?     @db.Text
  changes     Json?
  ipAddress   String?     @map("ip_address") @db.VarChar(100)
  userAgent   String?     @map("user_agent") @db.Text
  createdAt   DateTime    @default(now()) @map("created_at") @db.Timestamp(3)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId], name: "idx_audit_logs_user_id")
  @@index([createdAt], name: "idx_audit_logs_created_at")
  @@index([action], name: "idx_audit_logs_action")
  @@index([resource], name: "idx_audit_logs_resource")
  @@map("audit_logs")
}

// API 访问日志
model ApiLog {
  id           String     @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId       String?    @map("user_id") @db.Uuid
  method       HttpMethod
  path         String     @db.VarChar(500)
  statusCode   Int        @map("status_code")
  duration     Int // 毫秒
  ipAddress    String?    @map("ip_address") @db.VarChar(100)
  userAgent    String?    @map("user_agent") @db.Text
  requestBody  Json?      @map("request_body")
  responseBody Json?      @map("response_body")
  errorMessage String?    @map("error_message") @db.Text
  createdAt    DateTime   @default(now()) @map("created_at") @db.Timestamp(3)

  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId], name: "idx_api_logs_user_id")
  @@index([createdAt], name: "idx_api_logs_created_at")
  @@index([path], name: "idx_api_logs_path")
  @@index([statusCode], name: "idx_api_logs_status_code")
  @@map("api_logs")
}

// 组织（支持树形结构）
model Organization {
  id          String           @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name        String           @db.VarChar(255)
  slug        String           @unique @db.VarChar(100) // URL友好的唯一标识
  type        OrganizationType @default(DEPARTMENT) // 组织类型
  parentId    String?          @map("parent_id") @db.Uuid // 父组织ID
  description String?          @db.Text
  avatarUrl   String?          @map("avatar_url") @db.VarChar(500)
  isActive    Boolean          @default(true) @map("is_active")
  createdAt   DateTime         @default(now()) @map("created_at") @db.Timestamp(3)
  updatedAt   DateTime         @default(now()) @updatedAt @map("updated_at") @db.Timestamp(3)

  // 自引用关系
  parent   Organization?  @relation("OrganizationTree", fields: [parentId], references: [id], onDelete: Cascade)
  children Organization[] @relation("OrganizationTree")

  members OrganizationMember[]

  @@index([slug], name: "idx_organizations_slug")
  @@index([name], name: "idx_organizations_name")
  @@index([parentId], name: "idx_organizations_parent_id")
  @@index([type], name: "idx_organizations_type")
  @@map("organizations")
}

// 组织成员关系
model OrganizationMember {
  id             String           @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  organizationId String           @map("organization_id") @db.Uuid
  userId         String           @map("user_id") @db.Uuid
  role           OrganizationRole @default(MEMBER)
  joinedAt       DateTime         @default(now()) @map("joined_at") @db.Timestamp(3)

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([organizationId, userId])
  @@index([organizationId], name: "idx_org_members_org_id")
  @@index([userId], name: "idx_org_members_user_id")
  @@map("organization_members")
}

// API Key 主表
model ApiKey {
  id        String  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId    String  @map("user_id") @db.Uuid
  channelId String? @map("channel_id") @db.Uuid // 关联渠道（null=自动选择）

  // 基础信息
  name        String  @db.VarChar(255) // API Key 名称
  description String? @db.Text // API Key 描述
  key         String  @unique @db.VarChar(255) // 完整密钥值（明文存储）

  // 费用限制
  dailyCostLimit Decimal? @map("daily_cost_limit") @db.Decimal(12, 2) // 每日费用限制（null=无限）

  // 时间字段
  expiresAt  DateTime? @map("expires_at") @db.Timestamp(3) // 过期时间（null=永不过期）
  lastUsedAt DateTime? @map("last_used_at") @db.Timestamp(3) // 最后使用时间
  createdAt  DateTime  @default(now()) @map("created_at") @db.Timestamp(3)
  updatedAt  DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamp(3)
  deletedAt  DateTime? @map("deleted_at") @db.Timestamp(3) // 软删除时间

  // 状态和元数据
  status   KeyStatus @default(ACTIVE)
  metadata Json? // 其他元数据

  // 关联关系
  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  channel      Channel?      @relation(fields: [channelId], references: [id], onDelete: SetNull)
  usageRecords ApiKeyUsage[]

  @@index([userId], name: "idx_api_keys_user_id")
  @@index([channelId], name: "idx_api_keys_channel_id")
  @@index([key], name: "idx_api_keys_key")
  @@index([status], name: "idx_api_keys_status")
  @@index([expiresAt], name: "idx_api_keys_expires_at")
  @@index([deletedAt], name: "idx_api_keys_deleted_at")
  @@map("api_keys")
}

// API Key 用量记录表
model ApiKeyUsage {
  id     String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  keyId  String @map("key_id") @db.Uuid
  userId String @map("user_id") @db.Uuid // 冗余，便于用户级统计

  // 使用统计
  requestCount Int @default(0) @map("request_count") // 请求次数
  successCount Int @default(0) @map("success_count") // 成功次数
  failureCount Int @default(0) @map("failure_count") // 失败次数

  // 费用统计
  tokensUsed Int     @default(0) @map("tokens_used") // 消耗的Token数量（AI场景）
  cost       Decimal @default(0) @db.Decimal(12, 4) // 产生的费用

  // 时间字段（按小时或天聚合）
  periodStart DateTime @map("period_start") @db.Timestamp(3) // 统计周期开始
  periodEnd   DateTime @map("period_end") @db.Timestamp(3) // 统计周期结束
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamp(3)
  updatedAt   DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamp(3)

  // 元数据
  metadata Json? // 额外统计数据

  // 关联关系
  apiKey ApiKey @relation(fields: [keyId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([keyId, periodStart]) // 防止重复统计
  @@index([keyId], name: "idx_api_key_usage_key_id")
  @@index([userId], name: "idx_api_key_usage_user_id")
  @@index([periodStart], name: "idx_api_key_usage_period_start")
  @@index([createdAt], name: "idx_api_key_usage_created_at")
  @@map("api_key_usage")
}

// AI 提供商表
model AiProvider {
  id          String       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name        String       @db.VarChar(100) // 提供商名称，如 "OpenAI"
  slug        String       @unique @db.VarChar(50) // URL友好标识，如 "openai"
  type        ProviderType @default(CUSTOM) // 提供商类型
  logoUrl     String?      @map("logo_url") @db.VarChar(500) // Logo 地址
  website     String?      @db.VarChar(500) // 官网地址
  description String?      @db.Text // 描述信息
  isBuiltIn   Boolean      @default(false) @map("is_built_in") // 是否为预置提供商
  isActive    Boolean      @default(true) @map("is_active") // 是否启用
  sortOrder   Int          @default(0) @map("sort_order") // 排序
  metadata    Json? // 扩展元数据（API文档、特性等）
  createdAt   DateTime     @default(now()) @map("created_at") @db.Timestamp(3)
  updatedAt   DateTime     @default(now()) @updatedAt @map("updated_at") @db.Timestamp(3)

  channels Channel[]
  models   ProviderModel[]

  @@index([slug], name: "idx_ai_providers_slug")
  @@index([type], name: "idx_ai_providers_type")
  @@index([isActive], name: "idx_ai_providers_is_active")
  @@map("ai_providers")
}

// AI 提供商支持的模型
model ProviderModel {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  providerId  String   @map("provider_id") @db.Uuid
  modelName   String   @map("model_name") @db.VarChar(100) // 模型名称，如 "gpt-4"
  displayName String?  @map("display_name") @db.VarChar(200) // 显示名称，如 "GPT-4 Turbo"
  description String?  @db.Text // 模型描述
  isEnabled   Boolean  @default(true) @map("is_enabled") // 是否启用
  sortOrder   Int      @default(0) @map("sort_order") // 排序
  metadata    Json? // 模型元数据（价格、上下文长度、能力等）
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamp(3)
  updatedAt   DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamp(3)

  provider AiProvider @relation(fields: [providerId], references: [id], onDelete: Cascade)

  @@unique([providerId, modelName])
  @@index([providerId], name: "idx_provider_models_provider_id")
  @@index([modelName], name: "idx_provider_models_model_name")
  @@map("provider_models")
}

// 渠道表
model Channel {
  id         String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  providerId String @map("provider_id") @db.Uuid // 所属提供商

  // 基础信息
  name        String  @db.VarChar(255) // 渠道名称，如 "OpenAI 官方"
  description String? @db.Text // 描述，如 "官方API直连"

  // API 配置
  baseUrl String @map("base_url") @db.VarChar(500) // API 基础地址
  apiKey  String @map("api_key") @db.Text // API 密钥（需加密存储）

  // 状态
  status   ChannelStatus @default(ACTIVE)
  isActive Boolean       @default(true) @map("is_active") // 是否启用

  // 负载均衡
  priority   Int       @default(0) // 优先级，数值越小优先级越高
  lastUsedAt DateTime? @map("last_used_at") @db.Timestamp(3) // 最后使用时间

  // 限流管理
  rateLimitEndAt DateTime? @map("rate_limit_end_at") @db.Timestamp(3) // 限流结束时间

  // 健康检查
  lastHealthCheck DateTime? @map("last_health_check") @db.Timestamp(3)
  healthStatus    String?   @map("health_status") @db.VarChar(50) // healthy, unhealthy
  errorCount      Int       @default(0) @map("error_count") // 连续错误次数
  lastError       String?   @map("last_error") @db.Text // 最后的错误信息
  lastErrorAt     DateTime? @map("last_error_at") @db.Timestamp(3) // 最后错误时间

  // 时间和元数据
  createdAt DateTime  @default(now()) @map("created_at") @db.Timestamp(3)
  updatedAt DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamp(3)
  deletedAt DateTime? @map("deleted_at") @db.Timestamp(3) // 软删除
  metadata  Json? // 扩展配置（自定义请求头、代理设置、重试策略等）

  // 关联关系
  provider     AiProvider     @relation(fields: [providerId], references: [id], onDelete: Cascade)
  models       ChannelModel[]
  apiKeys      ApiKey[] // 使用该渠道的 API Keys
  usageRecords ChannelUsage[]

  @@index([providerId], name: "idx_channels_provider_id")
  @@index([status], name: "idx_channels_status")
  @@index([isActive], name: "idx_channels_is_active")
  @@index([deletedAt], name: "idx_channels_deleted_at")
  @@index([lastUsedAt], name: "idx_channels_last_used_at")
  @@map("channels")
}

// 渠道支持的模型
model ChannelModel {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  channelId String   @map("channel_id") @db.Uuid
  modelName String   @map("model_name") @db.VarChar(100) // 模型名称，如 "gpt-4"
  modelKey  String?  @map("model_key") @db.VarChar(100) // 模型映射键（如果渠道使用不同名称）
  isEnabled Boolean  @default(true) @map("is_enabled") // 是否启用
  metadata  Json? // 模型配置（价格、上下文长度等）
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamp(3)

  channel Channel @relation(fields: [channelId], references: [id], onDelete: Cascade)

  @@unique([channelId, modelName])
  @@index([channelId], name: "idx_channel_models_channel_id")
  @@index([modelName], name: "idx_channel_models_model_name")
  @@map("channel_models")
}

// 渠道使用统计
model ChannelUsage {
  id        String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  channelId String @map("channel_id") @db.Uuid
  apiKeyId  String @map("api_key_id") @db.Uuid // 使用的 API Key

  // 使用统计
  requestCount Int @default(0) @map("request_count") // 请求次数
  successCount Int @default(0) @map("success_count") // 成功次数
  failureCount Int @default(0) @map("failure_count") // 失败次数

  // 性能统计
  totalLatency Int     @default(0) @map("total_latency") // 总延迟（毫秒）
  avgLatency   Decimal @default(0) @map("avg_latency") @db.Decimal(10, 2) // 平均延迟
  tokensUsed   Int     @default(0) @map("tokens_used") // 消耗Token
  cost         Decimal @default(0) @db.Decimal(12, 4) // 产生费用

  // 时间字段（按小时或天聚合）
  periodStart DateTime @map("period_start") @db.Timestamp(3)
  periodEnd   DateTime @map("period_end") @db.Timestamp(3)
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamp(3)
  updatedAt   DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamp(3)

  metadata Json? // 额外统计数据

  channel Channel @relation(fields: [channelId], references: [id], onDelete: Cascade)

  @@unique([channelId, apiKeyId, periodStart])
  @@index([channelId], name: "idx_channel_usage_channel_id")
  @@index([apiKeyId], name: "idx_channel_usage_api_key_id")
  @@index([periodStart], name: "idx_channel_usage_period_start")
  @@map("channel_usage")
}
