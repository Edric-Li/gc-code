# API Token ç®¡ç†ç³»ç»Ÿå®ç°æ€»ç»“

> å®ç°æ—¥æœŸ: 2025-11-11
> çŠ¶æ€: Phase 1 & Phase 2 æ ¸å¿ƒåŠŸèƒ½å·²å®Œæˆ âœ…

---

## ğŸ“‹ å·²å®Œæˆçš„å·¥ä½œ

### Phase 1: æ•°æ®åº“å±‚ âœ…

#### 1.1 Prisma Schema æ›´æ–°

- âœ… æ·»åŠ  `TokenStatus` æšä¸¾ï¼ˆACTIVE, EXPIRED, REVOKED, DELETEDï¼‰
- âœ… æ·»åŠ  `ApiToken` æ¨¡å‹ï¼ˆå®Œæ•´å­—æ®µå®šä¹‰ï¼‰
- âœ… æ·»åŠ  `ApiTokenUsage` æ¨¡å‹ï¼ˆç”¨é‡ç»Ÿè®¡ï¼‰
- âœ… æ›´æ–° `User` æ¨¡å‹ï¼ˆæ·»åŠ å…³è”ï¼‰
- âœ… æ·»åŠ æ‰€æœ‰å¿…è¦çš„ç´¢å¼•ä¼˜åŒ–

**æ–‡ä»¶ä½ç½®**: `backend/prisma/schema.prisma`

#### 1.2 æ•°æ®åº“è¿ç§»

- âœ… è¿è¡Œ `prisma db push` åŒæ­¥æ•°æ®åº“
- âœ… ç”Ÿæˆ Prisma Client

---

### Phase 2: åç«¯æ ¸å¿ƒåŠŸèƒ½ âœ…

#### 2.1 ç›®å½•ç»“æ„

```
backend/src/modules/tokens/
â”œâ”€â”€ tokens.module.ts          # æ¨¡å—å®šä¹‰
â”œâ”€â”€ tokens.controller.ts      # API æ§åˆ¶å™¨
â”œâ”€â”€ tokens.service.ts         # ä¸šåŠ¡é€»è¾‘å±‚
â”œâ”€â”€ dto/                      # æ•°æ®ä¼ è¾“å¯¹è±¡
â”‚   â”œâ”€â”€ create-token.dto.ts
â”‚   â”œâ”€â”€ update-token.dto.ts
â”‚   â””â”€â”€ query-tokens.dto.ts
â”œâ”€â”€ guards/                   # å®ˆå«
â”‚   â””â”€â”€ api-token.guard.ts
â”œâ”€â”€ decorators/               # è£…é¥°å™¨
â”‚   â””â”€â”€ api-token.decorator.ts
â””â”€â”€ entities/                 # å“åº”å®ä½“
    â””â”€â”€ token-response.entity.ts
```

#### 2.2 æ ¸å¿ƒåŠŸèƒ½å®ç°

##### Tokens Service (`tokens.service.ts`)

å®ç°äº†ä»¥ä¸‹æ ¸å¿ƒæ–¹æ³•ï¼š

**ä»¤ç‰Œç®¡ç†**:

- âœ… `create()` - åˆ›å»ºä»¤ç‰Œï¼ˆç”Ÿæˆéšæœºä»¤ç‰Œ + SHA256 å“ˆå¸Œï¼‰
- âœ… `findAll()` - åˆ†é¡µæŸ¥è¯¢ä»¤ç‰Œåˆ—è¡¨
- âœ… `findOne()` - æŸ¥è¯¢å•ä¸ªä»¤ç‰Œè¯¦æƒ…
- âœ… `update()` - æ›´æ–°ä»¤ç‰Œä¿¡æ¯
- âœ… `softDelete()` - è½¯åˆ é™¤ä»¤ç‰Œ
- âœ… `revoke()` - æ’¤é”€ä»¤ç‰Œ
- âœ… `restore()` - æ¢å¤å·²åˆ é™¤çš„ä»¤ç‰Œ

**ä»¤ç‰ŒéªŒè¯**:

- âœ… `validateToken()` - éªŒè¯ä»¤ç‰Œæœ‰æ•ˆæ€§
  - æ£€æŸ¥ä»¤ç‰Œå“ˆå¸Œ
  - æ£€æŸ¥åˆ é™¤çŠ¶æ€
  - æ£€æŸ¥è¿‡æœŸæ—¶é—´
  - æ£€æŸ¥é¢åº¦å’Œè¯·æ±‚æ¬¡æ•°é™åˆ¶
  - æ›´æ–°ä½¿ç”¨ç»Ÿè®¡

**ç»Ÿè®¡åˆ†æ**:

- âœ… `getOverview()` - ç”¨æˆ·æ€»ä½“ç»Ÿè®¡
- âœ… `getTokenUsage()` - å•ä¸ªä»¤ç‰Œä½¿ç”¨è¶‹åŠ¿
- âœ… `getRanking()` - ç”¨é‡æ’è¡Œæ¦œ

##### Tokens Controller (`tokens.controller.ts`)

å®ç°çš„ API æ¥å£ï¼š

| æ–¹æ³•   | è·¯å¾„                     | æè¿°                 |
| ------ | ------------------------ | -------------------- |
| POST   | `/tokens`                | åˆ›å»ºæ–°ä»¤ç‰Œ           |
| GET    | `/tokens`                | æŸ¥è¯¢ä»¤ç‰Œåˆ—è¡¨ï¼ˆåˆ†é¡µï¼‰ |
| GET    | `/tokens/:id`            | æŸ¥è¯¢ä»¤ç‰Œè¯¦æƒ…         |
| PATCH  | `/tokens/:id`            | æ›´æ–°ä»¤ç‰Œ             |
| DELETE | `/tokens/:id`            | åˆ é™¤ä»¤ç‰Œï¼ˆè½¯åˆ é™¤ï¼‰   |
| POST   | `/tokens/:id/revoke`     | æ’¤é”€ä»¤ç‰Œ             |
| POST   | `/tokens/:id/restore`    | æ¢å¤å·²åˆ é™¤ä»¤ç‰Œ       |
| GET    | `/tokens/:id/usage`      | è·å–ä»¤ç‰Œä½¿ç”¨è¶‹åŠ¿     |
| GET    | `/tokens/stats/overview` | è·å–æ€»ä½“ç»Ÿè®¡         |
| GET    | `/tokens/stats/ranking`  | è·å–ç”¨é‡æ’è¡Œæ¦œ       |

##### API Token Guard (`api-token.guard.ts`)

- âœ… å®ç°ä»¤ç‰Œè®¤è¯å®ˆå«
- âœ… ä»è¯·æ±‚å¤´æå– Bearer token
- âœ… è°ƒç”¨ service éªŒè¯ä»¤ç‰Œ
- âœ… æ³¨å…¥ç”¨æˆ·å’Œä»¤ç‰Œä¿¡æ¯åˆ°è¯·æ±‚ä¸Šä¸‹æ–‡

##### è£…é¥°å™¨ (`api-token.decorator.ts`)

- âœ… `@ApiToken()` - è·å–å½“å‰ API Token
- âœ… `@CurrentUser()` - è·å–å½“å‰ç”¨æˆ·

#### 2.3 DTO å®ç°

- âœ… `CreateTokenDto` - åˆ›å»ºä»¤ç‰Œå‚æ•°éªŒè¯
- âœ… `UpdateTokenDto` - æ›´æ–°ä»¤ç‰Œå‚æ•°éªŒè¯
- âœ… `QueryTokensDto` - æŸ¥è¯¢åˆ—è¡¨å‚æ•°éªŒè¯
- âœ… `TokenUsageQueryDto` - ä½¿ç”¨è¶‹åŠ¿æŸ¥è¯¢å‚æ•°
- âœ… `TokenStatsQueryDto` - ç»Ÿè®¡æŸ¥è¯¢å‚æ•°
- âœ… `TokenRankingQueryDto` - æ’è¡Œæ¦œæŸ¥è¯¢å‚æ•°

#### 2.4 å“åº”å®ä½“

- âœ… `TokenResponseEntity` - ä»¤ç‰Œå“åº”å®ä½“
- âœ… `PaginatedTokensResponse` - åˆ†é¡µå“åº”
- âœ… `TokenUsageResponse` - ä½¿ç”¨è¶‹åŠ¿å“åº”
- âœ… `TokenStatsOverview` - æ€»ä½“ç»Ÿè®¡å“åº”
- âœ… `TokenRankingResponse` - æ’è¡Œæ¦œå“åº”

#### 2.5 æ¨¡å—é›†æˆ

- âœ… åˆ›å»º `TokensModule`
- âœ… é›†æˆåˆ° `AppModule`
- âœ… å¯¼å…¥ PrismaModule
- âœ… å¯¼å‡º TokensServiceï¼ˆä¾›å…¶ä»–æ¨¡å—ä½¿ç”¨ï¼‰

---

## ğŸ” å®‰å…¨ç‰¹æ€§

### ä»¤ç‰Œç”Ÿæˆ

- æ ¼å¼: `sk-{64ä½éšæœºhexå­—ç¬¦}`
- ä½¿ç”¨ `crypto.randomBytes(32)` ç”Ÿæˆé«˜å¼ºåº¦éšæœºæ•°
- æ€»é•¿åº¦: 67 å­—ç¬¦

### ä»¤ç‰Œå­˜å‚¨

- **å“ˆå¸Œç®—æ³•**: SHA-256
- **å­˜å‚¨ç­–ç•¥**:
  - æ•°æ®åº“ä¸å­˜å‚¨å®Œæ•´æ˜æ–‡ä»¤ç‰Œ
  - `token` å­—æ®µ: ä»…å­˜å‚¨å‰ç¼€å’Œåç¼€ï¼ˆå¦‚ `sk-1a2b3c***e2f`ï¼‰
  - `tokenHash` å­—æ®µ: å­˜å‚¨å®Œæ•´ SHA-256 å“ˆå¸Œ
- **æ˜æ–‡è¿”å›**: ä»…åœ¨åˆ›å»ºæ—¶è¿”å›ä¸€æ¬¡å®Œæ•´ä»¤ç‰Œ

### ä»¤ç‰ŒéªŒè¯æµç¨‹

1. ä»è¯·æ±‚å¤´æå–ä»¤ç‰Œ: `Authorization: Bearer sk-xxx...`
2. è®¡ç®—ä»¤ç‰Œçš„ SHA-256 å“ˆå¸Œå€¼
3. åœ¨æ•°æ®åº“ä¸­æŸ¥è¯¢ `tokenHash`
4. éªŒè¯æ£€æŸ¥:
   - ä»¤ç‰Œæ˜¯å¦å­˜åœ¨
   - `status == ACTIVE`
   - `deletedAt == null`
   - `expiresAt == null || expiresAt > now()`
   - `quotaLimit == null || quotaUsed < quotaLimit`
   - `requestLimit == null || requestCount < requestLimit`
5. éªŒè¯é€šè¿‡åæ›´æ–°:
   - `lastUsedAt = now()`
   - `requestCount += 1`
6. æ³¨å…¥ç”¨æˆ·ä¿¡æ¯åˆ°è¯·æ±‚ä¸Šä¸‹æ–‡

---

## ğŸ“Š æ ¸å¿ƒåŠŸèƒ½ç‰¹æ€§

### 1. è½¯åˆ é™¤æœºåˆ¶

- åˆ é™¤ä»¤ç‰Œæ—¶è®¾ç½® `deletedAt` æ—¶é—´æˆ³
- ä¿®æ”¹çŠ¶æ€ä¸º `DELETED`
- ä¿ç•™æ‰€æœ‰å†å²æ•°æ®å’Œç”¨é‡è®°å½•
- æ”¯æŒæ¢å¤å·²åˆ é™¤çš„ä»¤ç‰Œ

### 2. é¢åº¦æ§åˆ¶

- **é¢åº¦é™åˆ¶**: `quotaLimit`ï¼ˆnull = æ— é™ï¼‰
- **å·²ä½¿ç”¨é¢åº¦**: `quotaUsed`ï¼ˆå®æ—¶æ›´æ–°ï¼‰
- **è¯·æ±‚æ¬¡æ•°é™åˆ¶**: `requestLimit`ï¼ˆnull = æ— é™ï¼‰
- **å·²ä½¿ç”¨è¯·æ±‚**: `requestCount`ï¼ˆæ¯æ¬¡è°ƒç”¨é€’å¢ï¼‰

### 3. è¿‡æœŸç®¡ç†

- æ”¯æŒè®¾ç½®è¿‡æœŸæ—¶é—´ `expiresAt`
- null è¡¨ç¤ºæ°¸ä¸è¿‡æœŸ
- éªŒè¯æ—¶è‡ªåŠ¨æ£€æŸ¥å¹¶æ›´æ–°çŠ¶æ€ä¸º `EXPIRED`

### 4. æƒé™ç³»ç»Ÿï¼ˆé¢„ç•™ï¼‰

- `permissions` JSON å­—æ®µ
- æ”¯æŒç»†ç²’åº¦æƒé™æ§åˆ¶
- ç¤ºä¾‹: `["read", "write", "delete"]`

### 5. ç”¨é‡ç»Ÿè®¡

- ä»¤ç‰Œçº§åˆ«ç»Ÿè®¡ï¼ˆå•ä¸ªä»¤ç‰Œçš„ä½¿ç”¨æƒ…å†µï¼‰
- ç”¨æˆ·çº§åˆ«ç»Ÿè®¡ï¼ˆç”¨æˆ·æ‰€æœ‰ä»¤ç‰Œçš„æ€»ç”¨é‡ï¼‰
- æ”¯æŒæ—¶é—´èŒƒå›´æŸ¥è¯¢
- æ”¯æŒæŒ‰å¤©/å‘¨/æœˆèšåˆå±•ç¤º

---

## ğŸ”§ æŠ€æœ¯æ ˆ

| æŠ€æœ¯              | ç‰ˆæœ¬ | ç”¨é€”     |
| ----------------- | ---- | -------- |
| NestJS            | 10.x | åç«¯æ¡†æ¶ |
| TypeScript        | 5.x  | ç¼–ç¨‹è¯­è¨€ |
| Prisma            | 5.x  | ORM      |
| PostgreSQL        | 15   | æ•°æ®åº“   |
| class-validator   | 0.14 | å‚æ•°éªŒè¯ |
| class-transformer | 0.5  | æ•°æ®è½¬æ¢ |
| crypto (Node.js)  | -    | åŠ å¯†å“ˆå¸Œ |

---

## ğŸ“ ä½¿ç”¨ç¤ºä¾‹

### åˆ›å»ºä»¤ç‰Œ

```bash
POST /api/tokens
Authorization: Bearer <jwt_token>
Content-Type: application/json

{
  "name": "My API Token",
  "description": "ç”¨äºç”Ÿäº§ç¯å¢ƒçš„ä»¤ç‰Œ",
  "expiresAt": "2025-12-31T23:59:59Z",
  "quotaLimit": 1000.00,
  "requestLimit": 10000,
  "permissions": ["read", "write"]
}
```

**å“åº”**:

```json
{
  "id": "123e4567-e89b-12d3-a456-426614174000",
  "token": "sk-1a2b3c4d5e6f7g8h9i0j...", // å®Œæ•´ä»¤ç‰Œï¼Œä»…æ­¤ä¸€æ¬¡
  "name": "My API Token",
  "status": "ACTIVE",
  "quotaLimit": 1000.0,
  "quotaUsed": 0,
  "createdAt": "2025-11-11T10:00:00Z"
}
```

### ä½¿ç”¨ä»¤ç‰Œè°ƒç”¨ API

```bash
GET /api/some-protected-route
Authorization: Bearer sk-1a2b3c4d5e6f7g8h9i0j...
```

### æŸ¥è¯¢ä»¤ç‰Œåˆ—è¡¨

```bash
GET /api/tokens?page=1&limit=20&status=ACTIVE&search=production
Authorization: Bearer <jwt_token>
```

---

## ğŸš€ ä¸‹ä¸€æ­¥è®¡åˆ’

### Phase 3: ç»Ÿè®¡åˆ†æä¼˜åŒ–ï¼ˆå¾…å®ç°ï¼‰

- â¬œ å®ç°å®šæ—¶ä»»åŠ¡ï¼ˆä½¿ç”¨ `@nestjs/schedule`ï¼‰
- â¬œ å®ç°æ¯æ—¥èšåˆä»»åŠ¡ï¼ˆèšåˆåˆ° `api_token_usage` è¡¨ï¼‰
- â¬œ å®ç°å®æ—¶ç»Ÿè®¡æ›´æ–°
- â¬œ æ·»åŠ  Redis ç¼“å­˜ä¼˜åŒ–éªŒè¯æ€§èƒ½

### Phase 4: å‰ç«¯å¼€å‘ï¼ˆå¾…å®ç°ï¼‰

- â¬œ ä»¤ç‰Œç®¡ç†é¡µé¢
- â¬œ åˆ›å»ºä»¤ç‰Œå¼¹çª—
- â¬œ ä»¤ç‰Œè¯¦æƒ…é¡µé¢
- â¬œ ç»Ÿè®¡ä»ªè¡¨ç›˜
- â¬œ ä½¿ç”¨è¶‹åŠ¿å›¾è¡¨

### Phase 5: æµ‹è¯•å’Œä¼˜åŒ–ï¼ˆå¾…å®ç°ï¼‰

- â¬œ å•å…ƒæµ‹è¯•
- â¬œ é›†æˆæµ‹è¯•ï¼ˆE2Eï¼‰
- â¬œ æ€§èƒ½ä¼˜åŒ–
- â¬œ å®‰å…¨å®¡è®¡

---

## ğŸ“‚ ç›¸å…³æ–‡ä»¶

### åç«¯æ–‡ä»¶

- `backend/prisma/schema.prisma` - æ•°æ®åº“ schema
- `backend/src/modules/tokens/` - Tokens æ¨¡å—å®Œæ•´ä»£ç 
- `backend/src/app.module.ts` - æ¨¡å—é›†æˆ

### æ–‡æ¡£

- `docs/API_TOKEN_DESIGN.md` - è®¾è®¡æ–‡æ¡£
- `docs/API_TOKEN_IMPLEMENTATION.md` - å®ç°æ€»ç»“ï¼ˆæœ¬æ–‡æ¡£ï¼‰

---

## âœ… éªŒè¯æ¸…å•

- [x] Prisma schema æ›´æ–°å¹¶åŒæ­¥åˆ°æ•°æ®åº“
- [x] Prisma Client ç”ŸæˆæˆåŠŸ
- [x] Tokens Module åˆ›å»ºå¹¶é›†æˆåˆ° AppModule
- [x] æ‰€æœ‰ DTO å®ç°å¹¶æ·»åŠ éªŒè¯
- [x] Tokens Service æ‰€æœ‰æ ¸å¿ƒæ–¹æ³•å®ç°
- [x] Tokens Controller æ‰€æœ‰ API æ¥å£å®ç°
- [x] API Token Guard å®ç°
- [x] è£…é¥°å™¨å®ç°
- [x] ä»£ç æˆåŠŸç¼–è¯‘ï¼ˆ`npm run build`ï¼‰

---

## ğŸ‰ æ€»ç»“

Phase 1 å’Œ Phase 2 çš„æ ¸å¿ƒåŠŸèƒ½å·²å…¨éƒ¨å®ç°å®Œæˆï¼

**å·²å®ç°çš„æ ¸å¿ƒåŠŸèƒ½**:

- âœ… å®Œæ•´çš„ä»¤ç‰Œç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼ˆåˆ›å»ºã€æŸ¥è¯¢ã€æ›´æ–°ã€åˆ é™¤ã€æ’¤é”€ã€æ¢å¤ï¼‰
- âœ… å®‰å…¨çš„ä»¤ç‰Œç”Ÿæˆå’ŒéªŒè¯æœºåˆ¶ï¼ˆSHA-256 å“ˆå¸Œï¼‰
- âœ… è½¯åˆ é™¤æœºåˆ¶ï¼ˆä¿ç•™å†å²æ•°æ®ï¼‰
- âœ… é¢åº¦å’Œè¯·æ±‚æ¬¡æ•°æ§åˆ¶
- âœ… è¿‡æœŸæ—¶é—´ç®¡ç†
- âœ… ç”¨é‡ç»Ÿè®¡å’Œåˆ†æ
- âœ… RESTful API æ¥å£
- âœ… Swagger API æ–‡æ¡£é›†æˆ

**æŠ€æœ¯äº®ç‚¹**:

- ä½¿ç”¨ Prisma ORM ç¡®ä¿ç±»å‹å®‰å…¨
- class-validator ç¡®ä¿å‚æ•°éªŒè¯
- è½¯åˆ é™¤ä¿ç•™å®¡è®¡è¿½è¸ª
- é¢„ç•™æƒé™ç³»ç»Ÿæ‰©å±•
- å®Œæ•´çš„é”™è¯¯å¤„ç†

ç³»ç»Ÿå·²å‡†å¤‡å¥½è¿›è¡Œä¸‹ä¸€é˜¶æ®µçš„å¼€å‘å’Œæµ‹è¯•ï¼
